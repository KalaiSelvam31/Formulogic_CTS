<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormuLogic - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Space Grotesk', sans-serif; background: linear-gradient(135deg, #f8fffe 0%, #f0f8f0 100%); min-height: 100vh; color: #333; }
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); position: fixed; top: 0; width: 100%; z-index: 1000; }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; height: 70px; }
        .nav-logo h2 { font-size: 1.6rem; font-weight: 600; }
        .nav-logo .logic { color: #4ade80; }
        .main-content { margin-top: 70px; min-height: calc(100vh - 70px); display: grid; grid-template-columns: 1fr 1fr; }
        .illustration-side { background: linear-gradient(135deg, #1e3a2e 0%, #2d4a3e 100%); display: flex; align-items: center; justify-content: center; padding: 60px; color: white; }
        .illustration-content { max-width: 420px; }
        .illustration-heading { font-size: 2.8rem; font-weight: 700; line-height: 1.2; margin-bottom: 1rem; }
        .illustration-subheading { font-size: 1.1rem; opacity: 0.85; line-height: 1.6; margin-bottom: 3rem; }
        .features-list { list-style: none; padding: 0; }
        .features-list li { display: flex; align-items: center; font-size: 1rem; font-weight: 500; margin-bottom: 1.5rem; opacity: 0.9; }
        .features-list li svg { width: 24px; height: 24px; margin-right: 1rem; color: #4ade80; }
        .form-side { background: white; display: flex; align-items: center; justify-content: center; padding: 60px; }
        .form-container { width: 100%; max-width: 400px; }
        .auth-form-wrapper.hidden { display: none; }
        .form-header { text-align: center; margin-bottom: 32px; }
        .form-header h2 { font-size: 2rem; font-weight: 600; margin-bottom: 8px; }
        .input-group { margin-bottom: 24px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .input-group input { width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1rem; }
        .form-options { display: flex; justify-content: flex-end; margin-bottom: 24px; }
        .forgot-link { color: #4ade80; text-decoration: none; font-weight: 600; cursor: pointer; }
        .submit-btn { width: 100%; background: #4ade80; color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .notification { position: fixed; top: 90px; right: 20px; padding: 16px 24px; border-radius: 12px; font-weight: 500; z-index: 2000; transform: translateX(400px); transition: all 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #4ade80; color: white; }
        .notification.error { background: #ef4444; color: white; }
        .back-to-login { text-align: center; margin-top: 1.5rem; }
        .back-to-login a { color: #4ade80; text-decoration: none; font-weight: 600; }
        @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } .illustration-side { display: none; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo"><h2><a href="./index.html" style="text-decoration: none; color: inherit;">Formu<span class="logic">Logic</span></a></h2></div>
        </div>
    </nav>
    <main class="main-content">
        <div class="illustration-side">
            <div class="illustration-content">
                <h1 class="illustration-heading">Secure &amp; Intelligent PBM Platform</h1>
                <p class="illustration-subheading">Access powerful analytics to drive cost savings and improve outcomes.</p>
                <ul class="features-list">
                    <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><span>Advanced Formulary Analysis</span></li>
                    <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg><span>Drug Utilization Forecasting</span></li>
                    <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg><span>Cost-Saving Alternatives</span></li>
                </ul>
            </div>
        </div>
        <div class="form-side">
            <div class="form-container">
                <!-- Login Form -->
                <div class="auth-form-wrapper" id="loginFormContainer">
                    <div class="form-header"><h2>Welcome Back</h2><p>Enter your credentials to continue.</p></div>
                    <form id="loginForm">
                        <div class="input-group"><label for="email">Email</label><input type="email" id="email" required></div>
                        <div class="input-group"><label for="password">Password</label><input type="password" id="password" required></div>
                        <div class="form-options"><a class="forgot-link" id="forgotPasswordLink">Forgot password?</a></div>
                        <button type="submit" class="submit-btn">Login</button>
                    </form>
                </div>

                <!-- OTP Form -->
                <div class="auth-form-wrapper hidden" id="otpFormContainer">
                    <div class="form-header"><h2>Verify Your Login</h2><p>An OTP has been sent to your email. Please enter it to continue.</p></div>
                    <form id="otpForm">
                        <div class="input-group"><label for="loginOtp">OTP</label><input type="text" id="loginOtp" required></div>
                        <button type="submit" class="submit-btn">Verify & Sign In</button>
                    </form>
                </div>

                <!-- Forgot Password -->
                <div class="auth-form-wrapper hidden" id="forgotPasswordContainer">
                    <div class="form-header"><h2>Reset Password</h2><p>Enter your email to receive a reset OTP.</p></div>
                    <form id="requestResetOtpForm">
                        <div class="input-group"><label for="forgotEmail">Email</label><input type="email" id="forgotEmail" required></div>
                        <button type="submit" class="submit-btn">Send Reset OTP</button>
                    </form>
                    <div class="back-to-login"><a href="#" class="back-link">Back to Login</a></div>
                </div>
            </div>
        </div>
    </main>
    <div id="notification" class="notification"></div>

    <script>
        // âœ… If already logged in, go to features directly
        (function checkAlreadyLoggedIn() {
            const token = localStorage.getItem("access_token");
            if (token) {
                window.location.href = "./features.html";
            }
        })();

        function navigateTo(page, params = {}) {
            const url = new URL(page, window.location.origin);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            window.location.href = url.toString();
        }

        class FormuLogicAuth {
            constructor() {
                this.apiBase = 'http://127.0.0.1:8000';
                this.currentUserEmail = null;
                this.init();
            }
            init() {
                document.getElementById('loginForm').addEventListener('submit', this.handleLogin.bind(this));
                document.getElementById('otpForm').addEventListener('submit', this.handleOtpVerification.bind(this));
                document.getElementById('forgotPasswordLink').addEventListener('click', this.showForgotPasswordForm.bind(this));
                document.getElementById('requestResetOtpForm').addEventListener('submit', this.handleRequestResetOtp.bind(this));
                document.querySelector('.back-link').addEventListener('click', (e) => { e.preventDefault(); this.showLoginForm(); });
            }

            showLoginForm() {
                document.getElementById('loginFormContainer').classList.remove('hidden');
                document.getElementById('otpFormContainer').classList.add('hidden');
                document.getElementById('forgotPasswordContainer').classList.add('hidden');
            }
            showForgotPasswordForm(e) {
                if(e) e.preventDefault();
                document.getElementById('loginFormContainer').classList.add('hidden');
                document.getElementById('otpFormContainer').classList.add('hidden');
                document.getElementById('forgotPasswordContainer').classList.remove('hidden');
            }

            parseJwt(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch (e) {
                    console.error("Invalid token:", e);
                    return null;
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                const form = e.target;
                this.currentUserEmail = form.email.value;
                const data = { email: this.currentUserEmail, password: form.password.value };
                try {
                    const response = await this.apiCall('/auth/login', 'POST', data);
                    this.showNotification(response.message || 'OTP sent to your email.', 'success');
                    document.getElementById('loginFormContainer').classList.add('hidden');
                    document.getElementById('otpFormContainer').classList.remove('hidden');
                } catch (err) {
                    this.showNotification(err.message || 'Login failed.', 'error');
                }
            }

            async handleOtpVerification(e) {
                e.preventDefault();
                const form = e.target;
                const data = { email: this.currentUserEmail, otp: form.loginOtp.value };
                try {
                    const token = await this.apiCall('/auth/verify-login-otp', 'POST', data);
                    if (!token.access_token) throw new Error('Invalid token received');
                    localStorage.setItem('access_token', token.access_token);
                    this.showNotification('Login successful!', 'success');

                    const decodedToken = this.parseJwt(token.access_token);
                    if (decodedToken && (decodedToken.role === 'superuser' || decodedToken.role === 'rollback')) {
                        navigateTo('./superuser_register.html');
                    } else {
                        navigateTo('C:/Users/Kalaiselvam M/Desktop/Formulogic_CTS/static/features.html');
                    }
                } catch (err) {
                    this.showNotification(err.message || 'OTP verification failed.', 'error');
                }
            }

            async handleRequestResetOtp(e) {
                e.preventDefault();
                const form = e.target;
                const email = form.forgotEmail.value;
                try {
                    const endpoint = `/auth/request-password-reset?email=${encodeURIComponent(email)}`;
                    const response = await this.apiCall(endpoint, 'POST');
                    this.showNotification(response.message || 'Password reset OTP sent.', 'success');
                    navigateTo('./reset_password.html', { email: email });
                } catch (err) {
                    this.showNotification(err.message || 'Failed to send OTP.', 'error');
                }
            }

            async apiCall(endpoint, method, data) {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (data) options.body = JSON.stringify(data);
                const response = await fetch(`${this.apiBase}${endpoint}`, options);
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'An error occurred');
                return result;
            }

            showNotification(msg, type) {
                const el = document.getElementById('notification');
                el.textContent = msg;
                el.className = `notification ${type} show`;
                setTimeout(() => el.classList.remove('show'), 4000);
            }
        }
        document.addEventListener('DOMContentLoaded', () => new FormuLogicAuth());
    </script>
</body>
</html>
